<!DOCTYPE html>
<html>
<head>
  <title>3D Force Graph Example</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
    }
    #slider-container {
      position: absolute;
      bottom: 20px;
      width: 100%;
    }
    #slider {
      width: 99%;
    }
  </style>
</head>
<body>
  <div id='3d-graph'></div>
  <div id='slider-container'>
    <input type='range' id='slider' min='0' max='4000' value='1000'>
  </div>
  <script src='https://unpkg.com/3d-force-graph'></script>

  <script>

async function main () {
  console.log('Fetching JSON data...');
  const response = await fetch('https://k-web3.fillthatvoid.com/data/all.json');
  const data = await response.json();
  console.log('Fetched JSON data.');

  let { nodes, links } = data;
  nodes = nodes.filter(node => node.kind === 1);
  console.log(`Initial nodes: ${nodes.length}, links: ${links.length}`);
  nodes = nodes.filter(node => node.birth.date) // NOTE keep only people (with birthdates for this)
  nodes.map(node => {
    let year = node.birth.date.split('-')[0] || '0'
    year = year.replaceAll('+', '') * 1
    node.year = year + 25 // a bit random but this is just a test.
  })

  const nodeIds = new Set(nodes.map(node => node.id));
  links = links.filter(link => nodeIds.has(link.source) && nodeIds.has(link.target));
  console.log(`Filtered nodes: ${nodes.length}, links: ${links.length}`);

  const Graph = ForceGraph3D()(document.getElementById('3d-graph'));
  Graph.graphData({ nodes, links });
  Graph.enableNodeDrag(false);

  const slider = document.getElementById('slider');
  slider.max = nodes.length;
  slider.value = 1000;

  const nodeIndexMap = new Map();
  nodes.forEach((node, idx) => nodeIndexMap.set(node.id, idx));

  let threshold = 1000;
  slider.addEventListener('input', function() {
    threshold = parseInt(slider.value, 10);
    console.log(`Slider value: ${threshold}`);
    Graph.nodeVisibility((node, idx) => idx < threshold);
    Graph.linkVisibility(link => nodeIndexMap.get(link.source.id) < threshold && nodeIndexMap.get(link.target.id) < threshold);
  });

  setTimeout(() => {
    Graph.nodeVisibility((node, idx) => idx < threshold);
    Graph.linkVisibility(link => nodeIndexMap.get(link.source.id) < threshold && nodeIndexMap.get(link.target.id) < threshold);
  }, 1)

  let flying
  flying = Graph.onEngineStop(() => {
    setInterval(() => {
      const visibleNodes = nodes.filter((node, idx) => idx < threshold);
      const randomNode = visibleNodes[Math.floor(Math.random() * visibleNodes.length)];
      const distance = 40;
      const distRatio = 1 + distance/Math.hypot(randomNode.x, randomNode.y, randomNode.z);
      const newPos = randomNode.x || randomNode.y || randomNode.z
        ? { x: randomNode.x * distRatio, y: randomNode.y * distRatio, z: randomNode.z * distRatio }
        : { x: 0, y: 0, z: distance };
      Graph.cameraPosition(newPos, randomNode, 3000);
    }, 7000);
  });
}
main()

  </script>
</body>
</html>
