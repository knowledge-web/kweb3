<!DOCTYPE html>
<html>
<head>
  <title>3D Force Graph Example</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
    }
    #slider-container {
      position: absolute;
      bottom: 20px;
      width: 100%;
    }
    #slider { width: 99%; }
    #cslider { width: 99%; }

    #year {
      position: absolute;
      top: 0;
      left: 0;
      font-size: 36px;
      font-family: sans-serif;
      color: #fff;
      opacity: 0.33;
      background: rgba(127, 127, 127, 0.1);
      padding: 0.5em 1em;
      z-index: 1000;
    }
  </style>
  <script src='https://unpkg.com/3d-force-graph'></script>
</head>
<body>
  <div id='year'>2023</div>
  <div id='3d-graph'></div>
  <div id='slider-container'>
    <input type='range' id='slider' min='1400' max='2023' value='2023'><br>
    <input type='range' id='cslider' min='1400' max='2023' step='1'>
  </div>

  <script type="importmap">{ "imports": { "three": "//unpkg.com/three/build/three.module.js" }}</script>
  <script type="module">
    import { UnrealBloomPass } from '//unpkg.com/three/examples/jsm/postprocessing/UnrealBloomPass.js';

async function main () {
  console.log('Fetching JSON data...');
  const response = await fetch('https://k-web3.fillthatvoid.com/data/all.json');
  const data = await response.json();
  console.log('Fetched JSON data.');

  let { nodes, links } = data;
  nodes = nodes.filter(node => node.kind === 1);
  console.log(`Initial nodes: ${nodes.length}, links: ${links.length}`);
  nodes = nodes.filter(node => node.birth.date) // NOTE keep only people (with birthdates for this)
  nodes.map(node => {
    let year = node.birth.date.split('-')[0] || '0'
    year = year.replaceAll('+', '') * 1
    node.year = year + 25 // a bit random but this is just a test.
    node.century = Math.floor(node.year / 100) * 100
    if (node.century < 1400) node.century = 1400
  })

  const nodeIds = new Set(nodes.map(node => node.id));
  links = links.filter(link => nodeIds.has(link.source) && nodeIds.has(link.target));
  console.log(`Filtered nodes: ${nodes.length}, links: ${links.length}`);

  const Graph = ForceGraph3D()(document.getElementById('3d-graph'));
  Graph.backgroundColor('#000000')
  Graph.graphData({ nodes, links });
  Graph.enableNodeDrag(false)
  Graph.warmupTicks(20)
  Graph.cooldownTicks(0)
  // Graph.nodeAutoColorBy('century')
  Graph.linkOpacity(0.075)
  Graph.onNodeClick(node => {
    clearTimeout(flying)
    flying = false
    focusNode(node)
  })

  // const bloomPass = new UnrealBloomPass();
  //   bloomPass.strength = 2;
  //   bloomPass.radius = 1;
  //   bloomPass.threshold = 0;
  //   Graph.postProcessingComposer().addPass(bloomPass);

  let threshold = 2023
  const slider = document.getElementById('slider')
  slider.value = threshold

  let cent = 1700
  const cslider = document.getElementById('cslider')
  cslider.value = cent

  const nodeIndexMap = new Map()
  nodes.forEach(node => nodeIndexMap.set(node.id, node.year))
  const nodeIndexC = new Map()
  nodes.forEach(node => nodeIndexC.set(node.id, node.century))

  slider.addEventListener('input', function() {
    threshold = parseInt(slider.value, 10)
    Graph.nodeVisibility(node => node.year < threshold)
    Graph.linkVisibility(link => nodeIndexMap.get(link.source.id) < threshold && nodeIndexMap.get(link.target.id) < threshold)
    document.getElementById('year').innerHTML = threshold
  })

  cslider.addEventListener('input', function() {
    // Graph.nodeColor(Graph.nodeColor()) // OLD Version also set #cslider step=100 in the HTML
    // Graph.linkColor(Graph.linkColor())
    // return
    cent = parseInt(cslider.value, 10);
    const yearLowerBound = cent - 100; // Set lower bound to 100 years before the selected year

    Graph.nodeVisibility(node => node.year <= cent && node.year > yearLowerBound);
    Graph.linkVisibility(link => {
      const sourceVisibility = nodeIndexMap.get(link.source.id) <= cent && nodeIndexMap.get(link.source.id) > yearLowerBound;
      const targetVisibility = nodeIndexMap.get(link.target.id) <= cent && nodeIndexMap.get(link.target.id) > yearLowerBound;
      return sourceVisibility && targetVisibility;
    });
    document.getElementById('year').innerHTML = `${cent - 100} - ${cent}`;
  });

  setTimeout(() => {
    Graph.nodeVisibility(node => node.year < threshold)
    Graph.linkVisibility(link => nodeIndexMap.get(link.source.id) < threshold && nodeIndexMap.get(link.target.id) < threshold)
    Graph.nodeColor(node => {
      const colors = [
        "rgba(74, 20, 140, A)",  // Dark Purple
        "rgba(25, 118, 210, A)", // Medium Blue
        "rgba(56, 142, 60, A)",  // Green
        "rgba(251, 192, 45, A)", // Yellow
        "rgba(245, 124, 0, A)",  // Orange
        "rgba(194, 24, 91, A)",  // Pink
        "rgba(211, 47, 47, A)"   // Red
      ];

      const alpha = node.century == cent ? 1 : 1
      return colors[node.century / 100 - 14].replace('A', alpha)
    })
    Graph.linkColor(link => {
      const alpha = nodeIndexC.get(link.source.id) == cent && nodeIndexC.get(link.target.id) == cent ? 1 : 1
      return `rgba(255, 255, 255, ${alpha})`
    })
  }, 1)

  function focusNode (node) {
    const distance = 40
    const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z)
    const newPos = node.x || node.y || node.z
      ? { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }
      : { x: 0, y: 0, z: distance }
    Graph.cameraPosition(newPos, node, 3000)
  }

  function focusRandomNode () {
    const visibleNodes = nodes.filter(node => node.year < threshold)
    const randomNode = visibleNodes[Math.floor(Math.random() * visibleNodes.length)]
    focusNode(randomNode)
  }

  let flying
  function randomNodeRepeat() {
    focusRandomNode()
    flying = setTimeout(() => randomNodeRepeat, 7000)
  }

  Graph.onEngineStop(() => {
    if (flying === false) return
    setTimeout(randomNodeRepeat, 3000)
  })
}
main()

  </script>
</body>
</html>
